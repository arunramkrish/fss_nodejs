<!DOCTYPE html>
<!-- saved from url=(0052)https://nodejs.org/dist/latest-v4.x/docs/api/vm.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>Executing JavaScript Node.js v4.4.0 Manual &amp; Documentation</title>
  <link rel="stylesheet" href="./6_VM_ExecutingJavaScriptNode.js_files/css">
  <link rel="stylesheet" href="./6_VM_ExecutingJavaScriptNode.js_files/style.css">
  <link rel="stylesheet" href="./6_VM_ExecutingJavaScriptNode.js_files/sh.css">
  <link rel="canonical" href="https://nodejs.org/api/vm.html">
<style type="text/css"></style></head>
<body class="alt apidoc" id="api-section-vm">
  <div id="content" class="clearfix">
    <div id="column2" class="interior">
      <div id="intro" class="interior">
        <a href="https://nodejs.org/" title="Go back to the home page">
          Node.js (1)
        </a>
      </div>
      <ul>
<li><a class="nav-documentation" href="https://nodejs.org/dist/latest-v4.x/docs/api/documentation.html">About these Docs</a></li>
<li><a class="nav-synopsis" href="https://nodejs.org/dist/latest-v4.x/docs/api/synopsis.html">Synopsis</a></li>
<li><a class="nav-assert" href="https://nodejs.org/dist/latest-v4.x/docs/api/assert.html">Assertion Testing</a></li>
<li><a class="nav-buffer" href="https://nodejs.org/dist/latest-v4.x/docs/api/buffer.html">Buffer</a></li>
<li><a class="nav-addons" href="https://nodejs.org/dist/latest-v4.x/docs/api/addons.html">C/C++ Addons</a></li>
<li><a class="nav-child_process" href="https://nodejs.org/dist/latest-v4.x/docs/api/child_process.html">Child Processes</a></li>
<li><a class="nav-cluster" href="https://nodejs.org/dist/latest-v4.x/docs/api/cluster.html">Cluster</a></li>
<li><a class="nav-console" href="https://nodejs.org/dist/latest-v4.x/docs/api/console.html">Console</a></li>
<li><a class="nav-crypto" href="https://nodejs.org/dist/latest-v4.x/docs/api/crypto.html">Crypto</a></li>
<li><a class="nav-debugger" href="https://nodejs.org/dist/latest-v4.x/docs/api/debugger.html">Debugger</a></li>
<li><a class="nav-dns" href="https://nodejs.org/dist/latest-v4.x/docs/api/dns.html">DNS</a></li>
<li><a class="nav-domain" href="https://nodejs.org/dist/latest-v4.x/docs/api/domain.html">Domain</a></li>
<li><a class="nav-errors" href="https://nodejs.org/dist/latest-v4.x/docs/api/errors.html">Errors</a></li>
<li><a class="nav-events" href="https://nodejs.org/dist/latest-v4.x/docs/api/events.html">Events</a></li>
<li><a class="nav-fs" href="https://nodejs.org/dist/latest-v4.x/docs/api/fs.html">File System</a></li>
<li><a class="nav-globals" href="https://nodejs.org/dist/latest-v4.x/docs/api/globals.html">Globals</a></li>
<li><a class="nav-http" href="https://nodejs.org/dist/latest-v4.x/docs/api/http.html">HTTP</a></li>
<li><a class="nav-https" href="https://nodejs.org/dist/latest-v4.x/docs/api/https.html">HTTPS</a></li>
<li><a class="nav-modules" href="https://nodejs.org/dist/latest-v4.x/docs/api/modules.html">Modules</a></li>
<li><a class="nav-net" href="https://nodejs.org/dist/latest-v4.x/docs/api/net.html">Net</a></li>
<li><a class="nav-os" href="https://nodejs.org/dist/latest-v4.x/docs/api/os.html">OS</a></li>
<li><a class="nav-path" href="https://nodejs.org/dist/latest-v4.x/docs/api/path.html">Path</a></li>
<li><a class="nav-process" href="https://nodejs.org/dist/latest-v4.x/docs/api/process.html">Process</a></li>
<li><a class="nav-punycode" href="https://nodejs.org/dist/latest-v4.x/docs/api/punycode.html">Punycode</a></li>
<li><a class="nav-querystring" href="https://nodejs.org/dist/latest-v4.x/docs/api/querystring.html">Query Strings</a></li>
<li><a class="nav-readline" href="https://nodejs.org/dist/latest-v4.x/docs/api/readline.html">Readline</a></li>
<li><a class="nav-repl" href="https://nodejs.org/dist/latest-v4.x/docs/api/repl.html">REPL</a></li>
<li><a class="nav-stream" href="https://nodejs.org/dist/latest-v4.x/docs/api/stream.html">Stream</a></li>
<li><a class="nav-string_decoder" href="https://nodejs.org/dist/latest-v4.x/docs/api/string_decoder.html">String Decoder</a></li>
<li><a class="nav-timers" href="https://nodejs.org/dist/latest-v4.x/docs/api/timers.html">Timers</a></li>
<li><a class="nav-tls" href="https://nodejs.org/dist/latest-v4.x/docs/api/tls.html">TLS/SSL</a></li>
<li><a class="nav-tty" href="https://nodejs.org/dist/latest-v4.x/docs/api/tty.html">TTY</a></li>
<li><a class="nav-dgram" href="https://nodejs.org/dist/latest-v4.x/docs/api/dgram.html">UDP/Datagram</a></li>
<li><a class="nav-url" href="https://nodejs.org/dist/latest-v4.x/docs/api/url.html">URL</a></li>
<li><a class="nav-util" href="https://nodejs.org/dist/latest-v4.x/docs/api/util.html">Utilities</a></li>
<li><a class="nav-v8" href="https://nodejs.org/dist/latest-v4.x/docs/api/v8.html">V8</a></li>
<li><a class="nav-vm active" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html">VM</a></li>
<li><a class="nav-zlib" href="https://nodejs.org/dist/latest-v4.x/docs/api/zlib.html">ZLIB</a></li>
</ul>

    </div>

    <div id="column1" data-id="vm" class="interior">
      <header>
        <h1>Node.js v4.4.0 Documentation</h1>
        <div id="gtoc">
          <p>
            <a href="https://nodejs.org/dist/latest-v4.x/docs/api/index.html" name="toc">Index</a> |
            <a href="https://nodejs.org/dist/latest-v4.x/docs/api/all.html">View on single page</a> |
            <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.json">View as JSON</a>
          </p>
        </div>
        <hr>
      </header>

      <div id="toc">
        <h2>Table of Contents</h2>
        <ul>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_executing_javascript">Executing JavaScript</a><ul>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_class_script">Class: Script</a><ul>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_new_vm_script_code_options">new vm.Script(code, options)</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runincontext_contextifiedsandbox_options">script.runInContext(contextifiedSandbox[, options])</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runinnewcontext_sandbox_options">script.runInNewContext([sandbox][, options])</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runinthiscontext_options">script.runInThisContext([options])</a></li>
</ul>
</li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_createcontext_sandbox">vm.createContext([sandbox])</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_iscontext_sandbox">vm.isContext(sandbox)</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runincontext_code_contextifiedsandbox_options">vm.runInContext(code, contextifiedSandbox[, options])</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runindebugcontext_code">vm.runInDebugContext(code)</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinnewcontext_code_sandbox_options">vm.runInNewContext(code[, sandbox][, options])</a></li>
<li><a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinthiscontext_code_options">vm.runInThisContext(code[, options])</a></li>
</ul>
</li>
</ul>

      </div>

      <div id="apicontent">
        <h1>Executing JavaScript<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_executing_javascript" id="vm_executing_javascript">#</a></span></h1>
<pre class="api_stability api_stability_2 sh_sourceCode">Stability<span class="sh_symbol">:</span> <span class="sh_number">2</span> <span class="sh_symbol">-</span> Stable</pre><!--name=vm-->

<p>You can access this module with:

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span></code></pre>
<p>JavaScript code can be compiled and run immediately or compiled, saved, and run
later.

</p>
<h2>Class: Script<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_class_script" id="vm_class_script">#</a></span></h2>
<p>A class for holding precompiled scripts, and running them in specific sandboxes.

</p>
<h3>new vm.Script(code, options)<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_new_vm_script_code_options" id="vm_new_vm_script_code_options">#</a></span></h3>
<p>Creating a new <code>Script</code> compiles <code>code</code> but does not run it. Instead, the
created <code>vm.Script</code> object represents this compiled code. This script can be run
later many times using methods below. The returned script is not bound to any
global object. It is bound before each run, just for that run.

</p>
<p>The options when creating a script are:

</p>
<ul>
<li><code>filename</code>: allows you to control the filename that shows up in any stack
traces produced from this script.</li>
<li><code>lineOffset</code>: allows you to add an offset to the line number that is
displayed in stack traces</li>
<li><code>columnOffset</code>: allows you to add an offset to the column number that is
displayed in stack traces</li>
<li><code>displayErrors</code>: whether or not to print any errors to stderr, with the
line of code that caused them highlighted, before throwing an exception.
Applies only to syntax errors compiling the code; errors while running the
code are controlled by the options to the script's methods.</li>
<li><code>timeout</code>: a number of milliseconds to execute <code>code</code> before terminating
execution. If execution is terminated, an <a href="https://nodejs.org/dist/latest-v4.x/docs/api/errors.html#errors_class_error"><code>Error</code></a> will be thrown.</li>
</ul>
<h3>script.runInContext(contextifiedSandbox[, options])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runincontext_contextifiedsandbox_options" id="vm_script_runincontext_contextifiedsandbox_options">#</a></span></h3>
<p>Similar to <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runincontext_code_contextifiedsandbox_options"><code>vm.runInContext()</code></a> but a method of a precompiled <code>Script</code>
object. <code>script.runInContext()</code> runs <code>script</code>'s compiled code in
<code>contextifiedSandbox</code> and returns the result. Running code does not have access
to local scope.

</p>
<p><code>script.runInContext()</code> takes the same options as
<a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runinthiscontext_options"><code>script.runInThisContext()</code></a>.

</p>
<p>Example: compile code that increments a global variable and sets one, then
execute the code multiple times. These globals are contained in the sandbox.

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> util <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'util'</span><span class="sh_symbol">);</span>
<span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span>

<span class="sh_keyword">var</span> sandbox <span class="sh_symbol">=</span> <span class="sh_cbracket">{</span>
  animal<span class="sh_symbol">:</span> <span class="sh_string">'cat'</span><span class="sh_symbol">,</span>
  count<span class="sh_symbol">:</span> <span class="sh_number">2</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

<span class="sh_keyword">var</span> context <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> vm<span class="sh_symbol">.</span><span class="sh_function">createContext</span><span class="sh_symbol">(</span>sandbox<span class="sh_symbol">);</span>
<span class="sh_keyword">var</span> script <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> vm<span class="sh_symbol">.</span><span class="sh_function">Script</span><span class="sh_symbol">(</span><span class="sh_string">'count += 1; name = "kitty"'</span><span class="sh_symbol">);</span>

<span class="sh_keyword">for</span> <span class="sh_symbol">(</span><span class="sh_keyword">var</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">10</span><span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>
  script<span class="sh_symbol">.</span><span class="sh_function">runInContext</span><span class="sh_symbol">(</span>context<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>

console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span>util<span class="sh_symbol">.</span><span class="sh_function">inspect</span><span class="sh_symbol">(</span>sandbox<span class="sh_symbol">));</span>

<span class="sh_comment">// { animal: 'cat', count: 12, name: 'kitty' }</span></code></pre>
<p>Note that running untrusted code is a tricky business requiring great care.
<code>script.runInContext()</code> is quite useful, but safely running untrusted code
requires a separate process.

</p>
<h3>script.runInNewContext([sandbox][, options])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runinnewcontext_sandbox_options" id="vm_script_runinnewcontext_sandbox_options">#</a></span></h3>
<p>Similar to <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinnewcontext_code_sandbox_options"><code>vm.runInNewContext()</code></a> but a method of a precompiled <code>Script</code>
object. <code>script.runInNewContext()</code> contextifies <code>sandbox</code> if passed or creates a
new contextified sandbox if it's omitted, and then runs <code>script</code>'s compiled code
with the sandbox as the global object and returns the result. Running code does
not have access to local scope.

</p>
<p><code>script.runInNewContext()</code> takes the same options as
<a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runinthiscontext_options"><code>script.runInThisContext()</code></a>.

</p>
<p>Example: compile code that sets a global variable, then execute the code
multiple times in different contexts. These globals are set on and contained in
the sandboxes.

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> util <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'util'</span><span class="sh_symbol">);</span>
<span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span>

<span class="sh_keyword">const</span> sandboxes <span class="sh_symbol">=</span> <span class="sh_symbol">[</span><span class="sh_cbracket">{}</span><span class="sh_symbol">,</span> <span class="sh_cbracket">{}</span><span class="sh_symbol">,</span> <span class="sh_cbracket">{}</span><span class="sh_symbol">];</span>

<span class="sh_keyword">const</span> script <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> vm<span class="sh_symbol">.</span><span class="sh_function">Script</span><span class="sh_symbol">(</span><span class="sh_string">'globalVar = "set"'</span><span class="sh_symbol">);</span>

sandboxes<span class="sh_symbol">.</span><span class="sh_function">forEach</span><span class="sh_symbol">((</span>sandbox<span class="sh_symbol">)</span> <span class="sh_symbol">=&gt;</span> <span class="sh_cbracket">{</span>
  script<span class="sh_symbol">.</span><span class="sh_function">runInNewContext</span><span class="sh_symbol">(</span>sandbox<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">);</span>

console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span>util<span class="sh_symbol">.</span><span class="sh_function">inspect</span><span class="sh_symbol">(</span>sandboxes<span class="sh_symbol">));</span>

<span class="sh_comment">// [{ globalVar: 'set' }, { globalVar: 'set' }, { globalVar: 'set' }]</span></code></pre>
<p>Note that running untrusted code is a tricky business requiring great care.
<code>script.runInNewContext()</code> is quite useful, but safely running untrusted code
requires a separate process.

</p>
<h3>script.runInThisContext([options])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runinthiscontext_options" id="vm_script_runinthiscontext_options">#</a></span></h3>
<p>Similar to <a href=""><code>vm.runInThisContext()</code></a> but a method of a precompiled <code>Script</code>
object. <code>script.runInThisContext()</code> runs <code>script</code>'s compiled code and returns
the result. Running code does not have access to local scope, but does have
access to the current <code>global</code> object.

</p>
<p>Example of using <code>script.runInThisContext()</code> to compile code once and run it
multiple times:

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span>

global<span class="sh_symbol">.</span>globalVar <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span>

<span class="sh_keyword">const</span> script <span class="sh_symbol">=</span> <span class="sh_keyword">new</span> vm<span class="sh_symbol">.</span><span class="sh_function">Script</span><span class="sh_symbol">(</span><span class="sh_string">'globalVar += 1'</span><span class="sh_symbol">,</span> <span class="sh_cbracket">{</span> filename<span class="sh_symbol">:</span> <span class="sh_string">'myfile.vm'</span> <span class="sh_cbracket">}</span><span class="sh_symbol">);</span>

<span class="sh_keyword">for</span> <span class="sh_symbol">(</span><span class="sh_keyword">var</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">1000</span><span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>
  script<span class="sh_symbol">.</span><span class="sh_function">runInThisContext</span><span class="sh_symbol">();</span>
<span class="sh_cbracket">}</span>

console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span>globalVar<span class="sh_symbol">);</span>

<span class="sh_comment">// 1000</span></code></pre>
<p>The options for running a script are:

</p>
<ul>
<li><code>filename</code>: allows you to control the filename that shows up in any stack
traces produced.</li>
<li><code>lineOffset</code>: allows you to add an offset to the line number that is
displayed in stack traces</li>
<li><code>columnOffset</code>: allows you to add an offset to the column number that is
displayed in stack traces</li>
<li><code>displayErrors</code>: whether or not to print any errors to stderr, with the
line of code that caused them highlighted, before throwing an exception.
Applies only to runtime errors executing the code; it is impossible to create
a <code>Script</code> instance with syntax errors, as the constructor will throw.</li>
<li><code>timeout</code>: a number of milliseconds to execute the script before terminating
execution. If execution is terminated, an <a href="https://nodejs.org/dist/latest-v4.x/docs/api/errors.html#errors_class_error"><code>Error</code></a> will be thrown.</li>
</ul>
<h2>vm.createContext([sandbox])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_createcontext_sandbox" id="vm_vm_createcontext_sandbox">#</a></span></h2>
<p>If given a <code>sandbox</code> object, will "contextify" that sandbox so that it can be
used in calls to <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runincontext_code_contextifiedsandbox_options"><code>vm.runInContext()</code></a> or <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_script_runincontext_contextifiedsandbox_options"><code>script.runInContext()</code></a>. Inside
scripts run as such, <code>sandbox</code> will be the global object, retaining all its
existing properties but also having the built-in objects and functions any
standard <a href="https://es5.github.io/#x15.1">global object</a> has. Outside of scripts run by the vm module,
<code>sandbox</code> will be unchanged.

</p>
<p>If not given a sandbox object, returns a new, empty contextified sandbox object
you can use.

</p>
<p>This function is useful for creating a sandbox that can be used to run multiple
scripts, e.g. if you were emulating a web browser it could be used to create a
single sandbox representing a window's global object, then run all <code>&lt;script&gt;</code>
tags together inside that sandbox.

</p>
<h2>vm.isContext(sandbox)<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_iscontext_sandbox" id="vm_vm_iscontext_sandbox">#</a></span></h2>
<p>Returns whether or not a sandbox object has been contextified by calling
<a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_createcontext_sandbox"><code>vm.createContext()</code></a> on it.

</p>
<h2>vm.runInContext(code, contextifiedSandbox[, options])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runincontext_code_contextifiedsandbox_options" id="vm_vm_runincontext_code_contextifiedsandbox_options">#</a></span></h2>
<p><code>vm.runInContext()</code> compiles <code>code</code>, then runs it in <code>contextifiedSandbox</code> and
returns the result. Running code does not have access to local scope. The
<code>contextifiedSandbox</code> object must have been previously contextified via
<a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_createcontext_sandbox"><code>vm.createContext()</code></a>; it will be used as the global object for <code>code</code>.

</p>
<p><code>vm.runInContext()</code> takes the same options as <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinthiscontext_code_options"><code>vm.runInThisContext()</code></a>.

</p>
<p>Example: compile and execute different scripts in a single existing context.

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> util <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'util'</span><span class="sh_symbol">);</span>
<span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span>

<span class="sh_keyword">const</span> sandbox <span class="sh_symbol">=</span> <span class="sh_cbracket">{</span> globalVar<span class="sh_symbol">:</span> <span class="sh_number">1</span> <span class="sh_cbracket">}</span><span class="sh_symbol">;</span>
vm<span class="sh_symbol">.</span><span class="sh_function">createContext</span><span class="sh_symbol">(</span>sandbox<span class="sh_symbol">);</span>

<span class="sh_keyword">for</span> <span class="sh_symbol">(</span><span class="sh_keyword">var</span> i <span class="sh_symbol">=</span> <span class="sh_number">0</span><span class="sh_symbol">;</span> i <span class="sh_symbol">&lt;</span> <span class="sh_number">10</span><span class="sh_symbol">;</span> <span class="sh_symbol">++</span>i<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span>
    vm<span class="sh_symbol">.</span><span class="sh_function">runInContext</span><span class="sh_symbol">(</span><span class="sh_string">'globalVar *= 2;'</span><span class="sh_symbol">,</span> sandbox<span class="sh_symbol">);</span>
<span class="sh_cbracket">}</span>
console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span>util<span class="sh_symbol">.</span><span class="sh_function">inspect</span><span class="sh_symbol">(</span>sandbox<span class="sh_symbol">));</span>

<span class="sh_comment">// { globalVar: 1024 }</span></code></pre>
<p>Note that running untrusted code is a tricky business requiring great care.
<code>vm.runInContext()</code> is quite useful, but safely running untrusted code requires
a separate process.

</p>
<h2>vm.runInDebugContext(code)<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runindebugcontext_code" id="vm_vm_runindebugcontext_code">#</a></span></h2>
<p><code>vm.runInDebugContext()</code> compiles and executes <code>code</code> inside the V8 debug
context. The primary use case is to get access to the V8 debug object:

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> Debug <span class="sh_symbol">=</span> vm<span class="sh_symbol">.</span><span class="sh_function">runInDebugContext</span><span class="sh_symbol">(</span><span class="sh_string">'Debug'</span><span class="sh_symbol">);</span>
Debug<span class="sh_symbol">.</span><span class="sh_function">scripts</span><span class="sh_symbol">().</span><span class="sh_function">forEach</span><span class="sh_symbol">(</span><span class="sh_keyword">function</span><span class="sh_symbol">(</span>script<span class="sh_symbol">)</span> <span class="sh_cbracket">{</span> console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span>script<span class="sh_symbol">.</span>name<span class="sh_symbol">);</span> <span class="sh_cbracket">}</span><span class="sh_symbol">);</span></code></pre>
<p>Note that the debug context and object are intrinsically tied to V8's debugger
implementation and may change (or even get removed) without prior warning.

</p>
<p>The debug object can also be exposed with the <code>--expose_debug_as=</code> switch.

</p>
<h2>vm.runInNewContext(code[, sandbox][, options])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinnewcontext_code_sandbox_options" id="vm_vm_runinnewcontext_code_sandbox_options">#</a></span></h2>
<p><code>vm.runInNewContext()</code> compiles <code>code</code>, contextifies <code>sandbox</code> if passed or
creates a new contextified sandbox if it's omitted, and then runs the code with
the sandbox as the global object and returns the result.

</p>
<p><code>vm.runInNewContext()</code> takes the same options as <a href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinthiscontext_code_options"><code>vm.runInThisContext()</code></a>.

</p>
<p>Example: compile and execute code that increments a global variable and sets a
new one. These globals are contained in the sandbox.

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> util <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'util'</span><span class="sh_symbol">);</span>
<span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span>

<span class="sh_keyword">const</span> sandbox <span class="sh_symbol">=</span> <span class="sh_cbracket">{</span>
  animal<span class="sh_symbol">:</span> <span class="sh_string">'cat'</span><span class="sh_symbol">,</span>
  count<span class="sh_symbol">:</span> <span class="sh_number">2</span>
<span class="sh_cbracket">}</span><span class="sh_symbol">;</span>

vm<span class="sh_symbol">.</span><span class="sh_function">runInNewContext</span><span class="sh_symbol">(</span><span class="sh_string">'count += 1; name = "kitty"'</span><span class="sh_symbol">,</span> sandbox<span class="sh_symbol">);</span>
console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span>util<span class="sh_symbol">.</span><span class="sh_function">inspect</span><span class="sh_symbol">(</span>sandbox<span class="sh_symbol">));</span>

<span class="sh_comment">// { animal: 'cat', count: 3, name: 'kitty' }</span></code></pre>
<p>Note that running untrusted code is a tricky business requiring great care.
<code>vm.runInNewContext()</code> is quite useful, but safely running untrusted code requires
a separate process.

</p>
<h2>vm.runInThisContext(code[, options])<span><a class="mark" href="https://nodejs.org/dist/latest-v4.x/docs/api/vm.html#vm_vm_runinthiscontext_code_options" id="vm_vm_runinthiscontext_code_options">#</a></span></h2>
<p><code>vm.runInThisContext()</code> compiles <code>code</code>, runs it and returns the result. Running
code does not have access to local scope, but does have access to the current
<code>global</code> object.

</p>
<p>Example of using <code>vm.runInThisContext()</code> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval()</code></a> to run the same code:

</p>
<pre class="sh_sourceCode"><code class="js"><span class="sh_keyword">const</span> vm <span class="sh_symbol">=</span> <span class="sh_function">require</span><span class="sh_symbol">(</span><span class="sh_string">'vm'</span><span class="sh_symbol">);</span>
<span class="sh_keyword">var</span> localVar <span class="sh_symbol">=</span> <span class="sh_string">'initial value'</span><span class="sh_symbol">;</span>

<span class="sh_keyword">const</span> vmResult <span class="sh_symbol">=</span> vm<span class="sh_symbol">.</span><span class="sh_function">runInThisContext</span><span class="sh_symbol">(</span><span class="sh_string">'localVar = "vm";'</span><span class="sh_symbol">);</span>
console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span><span class="sh_string">'vmResult: '</span><span class="sh_symbol">,</span> vmResult<span class="sh_symbol">);</span>
console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span><span class="sh_string">'localVar: '</span><span class="sh_symbol">,</span> localVar<span class="sh_symbol">);</span>

<span class="sh_keyword">const</span> evalResult <span class="sh_symbol">=</span> <span class="sh_predef_func">eval</span><span class="sh_symbol">(</span><span class="sh_string">'localVar = "eval";'</span><span class="sh_symbol">);</span>
console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span><span class="sh_string">'evalResult: '</span><span class="sh_symbol">,</span> evalResult<span class="sh_symbol">);</span>
console<span class="sh_symbol">.</span><span class="sh_function">log</span><span class="sh_symbol">(</span><span class="sh_string">'localVar: '</span><span class="sh_symbol">,</span> localVar<span class="sh_symbol">);</span>

<span class="sh_comment">// vmResult: 'vm', localVar: 'initial value'</span>
<span class="sh_comment">// evalResult: 'eval', localVar: 'eval'</span></code></pre>
<p><code>vm.runInThisContext()</code> does not have access to the local scope, so <code>localVar</code>
is unchanged. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval()</code></a> does have access to the local scope, so <code>localVar</code> is
changed.

</p>
<p>In this way <code>vm.runInThisContext()</code> is much like an <a href="https://es5.github.io/#x10.4.2">indirect <code>eval()</code> call</a>,
e.g. <code>(0,eval)('code')</code>. However, it also has the following additional options:

</p>
<ul>
<li><code>filename</code>: allows you to control the filename that shows up in any stack
traces produced.</li>
<li><code>lineOffset</code>: allows you to add an offset to the line number that is
displayed in stack traces</li>
<li><code>columnOffset</code>: allows you to add an offset to the column number that is
displayed in stack traces</li>
<li><code>displayErrors</code>: whether or not to print any errors to stderr, with the
line of code that caused them highlighted, before throwing an exception.
Will capture both syntax errors from compiling <code>code</code> and runtime errors
thrown by executing the compiled code. Defaults to <code>true</code>.</li>
<li><code>timeout</code>: a number of milliseconds to execute <code>code</code> before terminating
execution. If execution is terminated, an <a href="https://nodejs.org/dist/latest-v4.x/docs/api/errors.html#errors_class_error"><code>Error</code></a> will be thrown.</li>
</ul>

      </div>
    </div>
  </div>
  <script src="./6_VM_ExecutingJavaScriptNode.js_files/sh_main.js"></script>
  <script src="./6_VM_ExecutingJavaScriptNode.js_files/sh_javascript.min.js"></script>
  <script>highlight(undefined, undefined, 'pre');</script>



</body></html>